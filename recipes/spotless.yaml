_include:
  - (pfb)stimela_cabs.yaml

opts:
  log:
    dir: logs
    nest: 2

spotless_recipe:
  name: "PFB spotless deconvolution recipe"
  info: "ssclean implemented using forward backward iterations"

  inputs:
    ms:
      dtype: MS
      required: true
      abbreviation: ms
    data_column:
      dtype: str
      default: DATA
      abbreviation: dc
    weight_column:
      dtype: str
      default: WEIGHT_SPECTRUM
      abbreviation: wc
    flag_column:
      dtype: str
      default: FLAG
      abbreviation: fc
    field_of_view:
      dtype: float
      abbreviation: fov
      required: true
      info: 'Field of view in degrees'
      metavar: DEG
    super_resolution_factor:
      dtype: float
      abbreviation: srf
      default: 2.0
      info: 'Will over-sample Nyquist by this factor at max frequency'

  # an alias is a recipe parameter that maps to parameters of step(s)
  aliases:
    output_filename: [init.output_filename,
              grid_bm1.output_filename, grid_bz.output_filename, grid_bp1.output_filename, grid_nat.output_filename,
              clean_bm1.output_filename, clean_bz.output_filename, clean_bp1.output_filename, clean_nat.output_filename,
              forward_bm1.output_filename, forward_bz.output_filename, forward_bp1.output_filename, forward_nat.output_filename,
              backward_bm1.output_filename, backward_bz.output_filename, backward_bp1.output_filename, backward_nat.output_filename]
    nband: [init.nband, grid_bm1.nband, grid_bz.nband, grid_bp1.nband, grid_nat.nband,
            clean_bm1.nband, clean_bz.nband, clean_bp1.nband, clean_nat.nband,
            forward_bm1.nband, forward_bz.nband, forward_bp1.nband, forward_nat.nband,
            backward_bm1.nband, backward_bz.nband, backward_bp1.nband, backward_nat.nband]
    nthreads: [init.nthreads, grid_bm1.nthreads, grid_bz.nthreads, grid_bp1.nthreads, grid_nat.nthreads,
               clean_bm1.nthreads, clean_bz.nthreads, clean_bp1.nthreads, clean_nat.nthreads,
               forward_bm1.nthreads, forward_bz.nthreads, forward_bp1.nthreads, forward_nat.nthreads,
               backward_bm1.nthreads, backward_bz.nthreads, backward_bp1.nthreads, backward_nat.nthreads]

  steps:
    init:
      cab: pfb.init
      params:
        data_column: '{recipe.data_column}'
        weight_column: '{recipe.weight_column}'
        flag_column: '{recipe.flag_column}'
        ms: '{recipe.ms}'
        max_field_of_view: '{recipe.field_of_view}'

    grid_bm1:
      cab: pfb.grid
      params:
        field_of_view: '{recipe.field_of_view}'
        super_resolution_factor: '{recipe.super_resolution_factor}'
        robustness: -1
        overwrite: true
        residual: false

    clean_bm1:
      cab: pfb.clean
      params:
        residual_name: DIRTY
        mask: mds
        update_mask: true
        nmiter: 3
        gamma: 0.05
        hogbom_maxit: 5000
        report_freq: 250

    forward_bm1:
      cab: pfb.forward
      params:
        sigmainv: 1e-5
        residual_name: DIRTY
        mask: mds

    backward_bm1:
      cab: pfb.backward
      params:
        mask: mds
        niter: 0
        pd_maxit: 50
        sigmainv: 1e-5
        sigma21: 1e-3
        alpha: 1e-3
        hessnorm: 1
        bases: self
        do_residual: false

    grid_bz:
      cab: pfb.grid
      params:
        field_of_view: '{recipe.field_of_view}'
        super_resolution_factor: '{recipe.super_resolution_factor}'
        robustness: 0
        overwrite: true

    clean_bz:
      cab: pfb.clean
      params:
        residual_name: RESIDUAL
        mask: mds
        update_mask: true
        nmiter: 3
        gamma: 0.05
        hogbom_maxit: 5000
        report_freq: 250

    forward_bz:
      cab: pfb.forward
      params:
        residual_name: RESIDUAL
        sigmainv: 1e-5
        mask: mds

    grid_bp1:
      cab: pfb.grid
      params:
        field_of_view: '{recipe.field_of_view}'
        super_resolution_factor: '{recipe.super_resolution_factor}'
        robustness: 1
        overwrite: true

    clean_bp1:
      cab: pfb.clean
      params:
        residual_name: RESIDUAL
        mask: mds
        update_mask: true
        nmiter: 3
        gamma: 0.05
        hogbom_maxit: 5000
        report_freq: 250

    forward_bp1:
      cab: pfb.forward
      params:
        sigmainv: 1e-5
        residual_name: RESIDUAL
        mask: mds
        do_residual: true

    backward_bp1:
      cab: pfb.backward
      params:
        mask: mds
        niter: 10
        pd_maxit: 50
        sigmainv: 1e-5

    grid_nat:
      cab: pfb.grid
      params:
        field_of_view: '{recipe.field_of_view}'
        super_resolution_factor: '{recipe.super_resolution_factor}'
        overwrite: true


    clean_nat:
      cab: pfb.clean
      params:
        residual_name: RESIDUAL
        mask: mds
        update_mask: true
        nmiter: 3
        gamma: 0.05
        hogbom_maxit: 5000
        report_freq: 250

    forward_nat:
      cab: pfb.forward
      params:
        sigmainv: 1e-5
        residual_name: RESIDUAL
        mask: mds
        do_residual: true

    backward_nat:
      cab: pfb.backward
      params:
        mask: mds
        niter: 10
        pd_maxit: 50
        sigmainv: 1e-5
